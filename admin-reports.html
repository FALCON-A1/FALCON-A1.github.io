<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Reports - Alpharia</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/teacher-dashboard.css">
    <style>
        .reports-container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .card { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .card h2 { margin-top: 0; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; }
        .progress-bar { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; }
        .progress { height: 100%; background: #4a6cf7; border-radius: 4px; }
    </style>
</head>
<body class="teacher-dashboard">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2>Alpharia <span class="admin-badge">Admin</span></h2>
            </div>
            
            <nav class="nav-menu">
                <div class="menu-title">Main Menu</div>
                
                <div class="nav-item">
                    <a href="admin-dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="admin-management.html" class="nav-link">
                        <i class="fas fa-users-cog"></i>
                        <span>Management</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="admin-tests.html" class="nav-link">
                        <i class="fas fa-clipboard-list"></i>
                        <span>All Tests</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="admin-create-test.html" class="nav-link">
                        <i class="fas fa-plus-circle"></i>
                        <span>Create Test</span>
                    </a>
                </div>
                
                <div class="menu-title mt-4">Analytics</div>
                
                <div class="nav-item">
                    <a href="admin-reports.html" class="nav-link active">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                    </a>
                </div>
                
                <div class="menu-title mt-4">Account</div>
                
                <div class="nav-item">
                    <a href="admin-settings.html" class="nav-link">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="#" id="logout" class="nav-link">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="sidebar-toggle" id="sidebar-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Admin Reports</h1>
                </div>
                <div class="top-bar-right">
                    <div class="user-menu">
                        <img id="admin-avatar" src="https://ui-avatars.com/api/?name=Admin" alt="Admin">
                        <span id="admin-name">Admin</span>
                    </div>
                </div>
            </header>

            <div class="reports-container">
                <!-- Quick Stats -->
                <div class="stats-grid">
                    <div class="card">
                        <h3>Total Teachers</h3>
                        <div class="value" id="total-teachers">0</div>
                    </div>
                    <div class="card">
                        <h3>Total Students</h3>
                        <div class="value" id="total-students">0</div>
                    </div>
                    <div class="card">
                        <h3>Active Tests</h3>
                        <div class="value" id="active-tests">0</div>
                    </div>
                    <div class="card">
                        <h3>Avg. Student Score</h3>
                        <div class="value" id="avg-score">0%</div>
                    </div>
                </div>

                <!-- Teacher Performance -->
                <div class="card">
                    <h2>Teacher Performance</h2>
                    <div class="filters">
                        <select id="time-period" class="form-control">
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table id="teacher-performance">
                            <thead>
                                <tr>
                                    <th>Teacher</th>
                                    <th>Students</th>
                                    <th>Avg. Score</th>
                                    <th>Tests Created</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody id="teacher-performance-body">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Student Progress -->
                <div class="card">
                    <h2>Student Progress</h2>
                    <div class="filters">
                        <select id="teacher-filter" class="form-control">
                            <option value="">All Teachers</option>
                        </select>
                        <select id="grade-filter" class="form-control">
                            <option value="">All Grades</option>
                            <option value="9">Grade 9</option>
                            <option value="10">Grade 10</option>
                            <option value="11">Grade 11</option>
                            <option value="12">Grade 12</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table id="student-progress">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Grade</th>
                                    <th>Teacher</th>
                                    <th>Points</th>
                                    <th>Last Test Score</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody id="student-progress-body">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Import Firebase services
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut 
        } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
        import { 
            getFirestore,
            collection, 
            getDocs, 
            query, 
            where, 
            orderBy,
            getDoc,
            doc as firestoreDoc,
            limit
        } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';
        
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAtOedXLBC4eigzqmBpYFciN-W5Mi2Cpmc",
            authDomain: "alpharia-c6a39.firebaseapp.com",
            projectId: "alpharia-c6a39",
            storageBucket: "alpharia-c6a39.firebasestorage.app",
            messagingSenderId: "85322759772",
            appId: "1:85322759772:web:d5c7a528fd61c9d2373099",
            measurementId: "G-KEC7MGMVE8"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Global variables to store data
        let allStudentsData = [];
        let allTeachersData = [];
        let gradeOptions = new Set();
        
        // Alias doc to avoid naming conflicts
        const doc = firestoreDoc;
        
        // Notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Add to the page
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        
        // Add some basic styles for notifications
        const style = document.createElement('style');
        style.textContent = `
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                border-radius: 4px;
                color: white;
                z-index: 1000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                transform: translateX(120%);
                transition: transform 0.3s ease-in-out;
            }
            .notification.show {
                transform: translateX(0);
            }
            .notification.fade-out {
                opacity: 0;
                transition: opacity 0.3s ease-in-out;
            }
            .notification.error { background-color: #f44336; }
            .notification.success { background-color: #4CAF50; }
            .notification.info { background-color: #2196F3; }
            .notification.warning { background-color: #ff9800; }
        `;
        document.head.appendChild(style);

        // Check authentication and load data
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'auth/login-fixed.html';
                return;
            }

            try {
                // First check in the admin collection
                const adminRef = firestoreDoc(db, 'admins', user.uid);
                const adminDoc = await getDoc(adminRef);
                
                // If not found in admins, check in users collection (for backward compatibility)
                if (!adminDoc.exists()) {
                    const userRef = firestoreDoc(db, 'users', user.uid);
                    const userDoc = await getDoc(userRef);
                    if (!userDoc.exists() || (userDoc.data().role !== 'admin' && userDoc.data().role !== 'ADMIN')) {
                        window.location.href = 'unauthorized.html';
                        return;
                    }
                }

                // Load reports data
                await loadReportsData();
                
            } catch (error) {
                console.error('Error in auth check or loading reports:', {
                    message: error.message,
                    code: error.code,
                    details: error.details || 'No additional details'
                });
                showNotification(`Authentication Error: ${error.message}`, 'error');
            }
        });

        async function loadReportsData() {
            try {
                // Show loading state
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'loading';
                loadingIndicator.textContent = 'Loading data...';
                document.querySelector('.reports-container').prepend(loadingIndicator);

                // Load all teachers from the 'teachers' collection
                const teachersQuery = collection(db, 'teachers');
                const teachersSnapshot = await getDocs(teachersQuery);
                const teachersData = [];
                
                // Process each teacher's data
                for (const doc of teachersSnapshot.docs) {
                    const teacher = doc.data();
                    teacher.id = doc.id;
                    // Ensure name fields are properly set
                    if (!teacher.firstName && teacher.name) {
                        // If name is stored in a single 'name' field
                        const nameParts = teacher.name.split(' ');
                        teacher.firstName = nameParts[0] || '';
                        teacher.lastName = nameParts.slice(1).join(' ') || '';
                    }
                    
                    // Get teacher's students
                    const studentsQuery = query(
                        collection(db, 'students'), 
                        where('teacherId', '==', doc.id)
                    );
                    const studentsSnapshot = await getDocs(studentsQuery);
                    teacher.studentCount = studentsSnapshot.size;
                    
                    // Get teacher's tests
                    const testsQuery = query(
                        collection(db, 'tests'),
                        where('createdBy', '==', doc.id)
                    );
                    const testsSnapshot = await getDocs(testsQuery);
                    teacher.testsCreated = testsSnapshot.size;
                    
                    // Calculate average score for teacher's students
                    let totalScore = 0;
                    let scoreCount = 0;
                    
                    for (const studentDoc of studentsSnapshot.docs) {
                        const studentData = studentDoc.data();
                        if (studentData.averageScore) {
                            totalScore += studentData.averageScore;
                            scoreCount++;
                        }
                    }
                    
                    teacher.avgScore = scoreCount > 0 ? (totalScore / scoreCount) : 0;
                    teachersData.push(teacher);
                }
                
                // Update teacher stats
                document.getElementById('total-teachers').textContent = teachersData.length;
                
                // Load all students from the 'students' collection
                const studentsQuery = collection(db, 'students');
                const studentsSnapshot = await getDocs(studentsQuery);
                const studentsData = [];
                
                // Process each student's data
                for (const doc of studentsSnapshot.docs) {
                    const student = doc.data();
                    student.id = doc.id;
                    
                    // Handle different name field formats
                    if (!student.firstName && student.name) {
                        // If name is stored in a single 'name' field
                        const nameParts = student.name.split(' ');
                        student.firstName = nameParts[0] || '';
                        student.lastName = nameParts.slice(1).join(' ') || '';
                    }
                    
                    // Get student's teacher info
                    if (student.teacherId) {
                        try {
                            const teacherRef = firestoreDoc(db, 'teachers', student.teacherId);
                            const teacherDoc = await getDoc(teacherRef);
                            if (teacherDoc.exists()) {
                                const teacherData = teacherDoc.data();
                                // Try different possible name field combinations
                                if (teacherData.firstName || teacherData.lastName) {
                                    student.teacherName = `${teacherData.firstName || ''} ${teacherData.lastName || ''}`.trim();
                                } else if (teacherData.name) {
                                    student.teacherName = teacherData.name;
                                } else if (teacherData.displayName) {
                                    student.teacherName = teacherData.displayName;
                                } else {
                                    student.teacherName = 'Teacher ' + student.teacherId.substring(0, 6);
                                }
                            } else {
                                student.teacherName = 'Teacher not found';
                                console.warn(`Teacher with ID ${student.teacherId} not found`);
                            }
                        } catch (error) {
                            console.error('Error fetching teacher data:', error);
                            student.teacherName = 'Error loading teacher';
                        }
                    } else {
                        student.teacherName = 'Unassigned';
                    }
                    
                    // Get student's test results (using a simpler query to avoid index requirements)
                    const resultsRef = collection(db, 'testResults');
                    const resultsQuery = where('studentId', '==', doc.id);
                    const resultsSnapshot = await getDocs(query(resultsRef, resultsQuery));
                    
                    if (!resultsSnapshot.empty) {
                        // Find the latest result manually in memory
                        let latestResult = null;
                        resultsSnapshot.forEach(doc => {
                            const result = doc.data();
                            if (!latestResult || 
                                (result.completedAt && 
                                 (!latestResult.completedAt || 
                                  result.completedAt.toDate() > latestResult.completedAt.toDate()))) {
                                latestResult = result;
                            }
                        });
                        
                        if (latestResult) {
                            student.lastTestScore = latestResult.score;
                            student.lastTestDate = latestResult.completedAt?.toDate() || new Date();
                        }
                    }
                    
                    studentsData.push(student);
                }
                
                // Update student stats
                document.getElementById('total-students').textContent = studentsData.length;
                
                // Calculate average score across all students
                const validScores = studentsData
                    .map(s => s.averageScore)
                    .filter(score => typeof score === 'number');
                    
                const avgScore = validScores.length > 0 
                    ? (validScores.reduce((a, b) => a + b, 0) / validScores.length) 
                    : 0;
                    
                document.getElementById('avg-score').textContent = `${Math.round(avgScore)}%`;
                
                // Load active tests
                const testsQuery = query(
                    collection(db, 'tests'),
                    where('isActive', '==', true)
                );
                
                const testsSnapshot = await getDocs(testsQuery);
                document.getElementById('active-tests').textContent = testsSnapshot.size;
                
                // Store the data globally
                allStudentsData = studentsData;
                allTeachersData = teachersData;
                
                // Extract unique grades from students
                gradeOptions = new Set(studentsData
                    .map(s => s.grade)
                    .filter(grade => grade && grade.trim() !== '')
                    .sort((a, b) => a.localeCompare(b, undefined, {numeric: true}))
                );
                
                // Populate teacher filter
                const teacherFilter = document.getElementById('teacher-filter');
                teacherFilter.innerHTML = '<option value="">All Teachers</option>';
                
                // Create a map of teacher IDs to their display names
                const teacherMap = new Map();
                allTeachersData.forEach(teacher => {
                    const teacherName = teacher.name || `${teacher.firstName || ''} ${teacher.lastName || ''}`.trim() || `Teacher ${teacher.id.substring(0, 6)}`;
                    teacherMap.set(teacher.id, teacherName);
                    
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacherName;
                    teacherFilter.appendChild(option);
                });
                
                // Populate grade filter
                const gradeFilter = document.getElementById('grade-filter');
                gradeFilter.innerHTML = '<option value="">All Grades</option>';
                gradeOptions.forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade;
                    option.textContent = `Grade ${grade}`;
                    gradeFilter.appendChild(option);
                });
                
                // Add event listeners
                teacherFilter.addEventListener('change', applyFilters);
                gradeFilter.addEventListener('change', applyFilters);
                
                // Store teacher map for later use
                window.teacherMap = teacherMap;
                
                // Initial UI update
                updateTeacherPerformance(teachersData);
                updateStudentProgress(studentsData);
                
                // Remove loading indicator
                if (loadingIndicator.parentNode) {
                    loadingIndicator.remove();
                }
                
            } catch (error) {
                console.error('Error loading reports data:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name,
                    code: error.code,
                    details: error.details || 'No additional details'
                });
                
                // Show detailed error to user for debugging
                showNotification(`Error: ${error.message || 'Failed to load reports data. Please check console for details.'}`, 'error');
                
                // Re-throw the error for further debugging if needed
                throw error;
            }
        }

        function updateTeacherPerformance(teachersData) {
            const tbody = document.getElementById('teacher-performance-body');
            tbody.innerHTML = '';

            if (teachersData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            No teacher data available
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort teachers by average score (descending)
            teachersData.sort((a, b) => (b.avgScore || 0) - (a.avgScore || 0));

            teachersData.forEach(teacher => {
                const avgScore = teacher.avgScore || 0;
                const scorePercentage = Math.round(avgScore * 100);
                
                const row = `
                    <tr>
                        <td>${teacher.firstName || ''} ${teacher.lastName || ''}</td>
                        <td>${teacher.studentCount || 0}</td>
                        <td>${scorePercentage}%</td>
                        <td>${teacher.testsCreated || 0}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress" style="width: ${scorePercentage}%"></div>
                            </div>
                            <small class="text-muted">${scorePercentage}%</small>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Apply filters and sorting to student data
        function applyFilters() {
            const teacherFilter = document.getElementById('teacher-filter').value;
            const gradeFilter = document.getElementById('grade-filter').value;
            
            let filteredStudents = [...allStudentsData];
            
            // Apply teacher filter
            if (teacherFilter) {
                filteredStudents = filteredStudents.filter(student => 
                    student.teacherId === teacherFilter
                );
            }
            
            // Apply grade filter
            if (gradeFilter) {
                filteredStudents = filteredStudents.filter(student => 
                    student.grade === gradeFilter
                );
            }
            
            // Update the UI with filtered data
            updateStudentProgress(filteredStudents);
        }
        
        function updateStudentProgress(studentsData) {
            const tbody = document.getElementById('student-progress-body');
            tbody.innerHTML = '';

            if (studentsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">
                            No student data available
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Default sort by last test date (most recent first)
            let sortedStudents = [...studentsData].sort((a, b) => {
                const dateA = a.lastTestDate ? new Date(a.lastTestDate) : new Date(0);
                const dateB = b.lastTestDate ? new Date(b.lastTestDate) : new Date(0);
                return dateB - dateA;
            });

            // Update student count in the UI
            document.getElementById('total-students').textContent = sortedStudents.length;
            
            sortedStudents.forEach(student => {
                const progress = student.progress || 0;
                const lastScore = student.lastTestScore ? 
                    `${Math.round(student.lastTestScore * 100)}%` : 'N/A';
                
                // Determine progress color based on score
                let progressClass = '';
                if (student.lastTestScore) {
                    if (student.lastTestScore >= 0.8) progressClass = 'bg-success';
                    else if (student.lastTestScore >= 0.5) progressClass = 'bg-warning';
                    else progressClass = 'bg-danger';
                }
                
                const row = `
                    <tr>
                        <td>${student.firstName || ''} ${student.lastName || ''}</td>
                        <td>${student.grade || 'N/A'}</td>
                        <td>${student.teacherName || 'Unassigned'}</td>
                        <td class="text-center">${student.points || 0}</td>
                        <td>${lastScore}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress ${progressClass}" style="width: ${progress}%"></div>
                            </div>
                            <small class="text-muted">${progress}%</small>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Logout functionality
        document.getElementById('logout').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await signOut(auth);
                window.location.href = 'auth/login-fixed.html';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        });

        // Sidebar toggle
        document.getElementById('sidebar-toggle').addEventListener('click', () => {
            document.body.classList.toggle('sidebar-collapsed');
        });
    </script>
</body>
</html>
