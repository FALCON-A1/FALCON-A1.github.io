<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Reading Test - Alpharia</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/teacher-dashboard.css">
    <link rel="stylesheet" href="css/test-creator.css">
</head>
<body class="teacher-dashboard">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h2>Alpharia</h2>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="teacher-dashboard.html" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link active">
                            <i class="fas fa-plus-circle"></i>
                            <span>Create Test</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="fas fa-file-alt"></i>
                            <span>My Tests</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span>Students</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <button id="logout-btn" class="btn btn-logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <h1>Create New Reading Test</h1>
                <div class="user-menu">
                    <div class="user-avatar">
                        <img src="https://ui-avatars.com/api/?name=Teacher+Name" alt="User" class="rounded-circle">
                    </div>
                </div>
            </header>

            <div class="test-creator-container">
                <!-- Test Info Section -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-info-circle"></i> Test Information</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="test-title">Test Title</label>
                            <input type="text" id="test-title" class="form-control" placeholder="Enter test title" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="test-grade">Grade Level</label>
                                <select id="test-grade" class="form-control" required>
                                    <option value="">Select grade</option>
                                    <option value="1">Grade 1</option>
                                    <option value="2">Grade 2</option>
                                    <option value="3">Grade 3</option>
                                    <option value="4">Grade 4</option>
                                    <option value="5">Grade 5</option>
                                    <option value="6">Grade 6</option>
                                    <option value="7">Grade 7</option>
                                    <option value="8">Grade 8</option>
                                    <option value="9">Grade 9</option>
                                    <option value="10">Grade 10</option>
                                    <option value="11">Grade 11</option>
                                    <option value="12">Grade 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="test-time-limit">Time Limit (minutes)</label>
                                <input type="number" id="test-time-limit" class="form-control" min="1" value="30">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="test-instructions">Instructions (Optional)</label>
                            <textarea id="test-instructions" class="form-control" rows="3" placeholder="Enter test instructions"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Sections Container -->
                <div id="sections-container" class="sections-container">
                    <!-- Sections will be added here dynamically -->
                </div>

                <!-- Add Section Button -->
                <div class="text-center">
                    <button type="button" class="btn btn-primary" id="add-section-btn">
                        <i class="fas fa-plus-circle"></i> Add Section
                    </button>
                </div>

                <!-- Save & Preview Buttons -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="save-draft-btn">
                        <i class="fas fa-save"></i> Save as Draft
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="preview-test-btn">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                    <button type="button" class="btn btn-success" id="publish-test-btn">
                        <i class="fas fa-paper-plane"></i> Publish Test
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Publish Modal -->
    <div id="publishModal" class="publish-modal">
        <div class="publish-modal-content">
            <div class="publish-icon">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <h3 id="publishTitle">Publishing Test</h3>
            <div class="publish-status" id="publishStatus">Preparing your test...</div>
            <div class="publish-progress">
                <div class="publish-progress-bar" id="publishProgress"></div>
            </div>
            <div class="publish-details" id="publishDetails">This may take a few moments</div>
            <button id="publishCloseBtn" class="btn btn-primary mt-3" style="display: none;">Close</button>
        </div>
    </div>

    <!-- Section Template (Hidden) -->
    <template id="section-template">
        <div class="card section-card" data-section-id="">
            <div class="card-header">
                <div class="section-header">
                    <h3 class="section-title">New Section</h3>
                    <div class="section-actions">
                        <button class="btn btn-sm btn-icon move-section-up" title="Move Up">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="btn btn-sm btn-icon move-section-down" title="Move Down">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="btn btn-sm btn-icon delete-section" title="Delete Section">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>Section Title</label>
                    <input type="text" class="form-control section-title-input" placeholder="Enter section title" required>
                </div>
                <div class="form-group">
                    <label>Instructions (Optional)</label>
                    <textarea class="form-control section-instructions" rows="2" placeholder="Enter section instructions"></textarea>
                </div>
                <div class="form-group">
                    <label>Section Type</label>
                    <select class="form-control section-type" required>
                        <option value="letters">Letters</option>
                        <option value="words">Words</option>
                        <option value="sentences">Sentences</option>
                        <option value="passage">Reading Passage</option>
                    </select>
                </div>
                
                <!-- Items Container -->
                <div class="items-container">
                    <!-- Items will be added here dynamically -->
                </div>
                
                <!-- Add Item Button -->
                <button class="btn btn-outline btn-sm add-item-btn">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
        </div>
    </template>

    <!-- Word Item Template -->
    <template id="word-item-template">
        <div class="item-card" data-item-type="word" data-item-id="">
            <div class="item-content">
                <div class="form-group">
                    <label>Word</label>
                    <input type="text" class="form-control item-text" placeholder="Enter word" required>
                </div>
                <div class="form-group">
                    <label>Points</label>
                    <input type="number" class="form-control item-points" min="1" value="1" required>
                </div>
            </div>
            <div class="item-actions">
                <button type="button" class="btn btn-sm btn-icon move-item-up" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon move-item-down" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon delete-item" title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </template>

    <!-- Letter Item Template -->
    <template id="letter-item-template">
        <div class="item-card" data-item-type="letter" data-item-id="">
            <div class="item-content">
                <div class="form-group">
                    <label>Letter</label>
                    <input type="text" class="form-control item-text" placeholder="Enter letter" maxlength="1" required>
                </div>
                <div class="form-group">
                    <label>Example Word</label>
                    <input type="text" class="form-control item-example" placeholder="Example word with this letter">
                </div>
                <div class="form-group">
                    <label>Points</label>
                    <input type="number" class="form-control item-points" min="1" value="1" required>
                </div>
            </div>
            <div class="item-actions">
                <button type="button" class="btn btn-sm btn-icon move-item-up" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon move-item-down" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon delete-item" title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </template>

    <!-- Sentence Item Template -->
    <template id="sentence-item-template">
        <div class="item-card" data-item-type="sentence" data-item-id="">
            <div class="item-content">
                <div class="form-group">
                    <label>Sentence</label>
                    <textarea class="form-control item-text" rows="2" placeholder="Enter sentence" required></textarea>
                </div>
                <div class="form-group">
                    <label>Focus Word</label>
                    <input type="text" class="form-control item-focus" placeholder="Word to focus on (optional)">
                </div>
                <div class="form-group">
                    <label>Points</label>
                    <input type="number" class="form-control item-points" min="1" value="2" required>
                </div>
            </div>
            <div class="item-actions">
                <button type="button" class="btn btn-sm btn-icon move-item-up" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon move-item-down" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon delete-item" title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </template>

    <!-- Passage Item Template -->
    <template id="passage-item-template">
        <div class="item-card" data-item-type="passage" data-item-id="">
            <div class="item-content">
                <div class="form-group">
                    <label>Passage Title</label>
                    <input type="text" class="form-control item-title" placeholder="Enter passage title" required>
                </div>
                <div class="form-group">
                    <label>Passage Content</label>
                    <textarea class="form-control item-text" rows="4" placeholder="Enter passage content" required></textarea>
                </div>
                <div class="form-group">
                    <label>Comprehension Question (Optional)</label>
                    <input type="text" class="form-control item-question" placeholder="Add a question about this passage">
                </div>
                <div class="form-group">
                    <label>Points</label>
                    <input type="number" class="form-control item-points" min="1" value="5" required>
                </div>
            </div>
            <div class="item-actions">
                <button type="button" class="btn btn-sm btn-icon move-item-up" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon move-item-down" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon delete-item" title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </template>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script type="module">
            // Import the functions you need from the SDKs you need
        import { 
            initializeApp,
            getApp,
            getApps
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged, 
            setPersistence, 
            browserLocalPersistence,
            browserSessionPersistence,
            connectAuthEmulator
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc, 
            deleteDoc, 
            getDocs, 
            query, 
            where, 
            orderBy, 
            limit, 
            serverTimestamp,
            connectFirestoreEmulator,
            enableMultiTabIndexedDbPersistence,
            CACHE_SIZE_UNLIMITED
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD8wzA2bX2jzvJ1wR4X5XwQdQk8cZ6X9Y0",
            authDomain: "alpharia-12345.firebaseapp.com",
            projectId: "alpharia-12345",
            storageBucket: "alpharia-12345.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abc123def456"
        };
        
        // Initialize Firebase in an async function
        async function initializeFirebaseApp() {
            try {
                // Initialize Firebase
                let app;
                try {
                    app = initializeApp(firebaseConfig);
                    console.log('Firebase app initialized with new instance');
                } catch (error) {
                    if (error.code === 'app/duplicate-app') {
                        // Get the existing app instance
                        app = getApp();
                        console.log('Using existing Firebase app instance');
                    } else {
                        throw error; // Re-throw other errors
                    }
                }
                
                // Initialize auth and firestore
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                // Try to set persistence
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    console.log('Auth persistence set to LOCAL');
                } catch (e) {
                    console.warn('Failed to set auth persistence:', e);
                    // Continue with db even if persistence fails
                }
                
                return { app, auth, db };
            } catch (error) {
                console.error('Fatal Firebase initialization error:', error);
                throw error; // Re-throw the error to be handled by the caller
            }
        }
        
        // Initialize Firebase and get the instances
        const { app, auth, db } = await initializeFirebaseApp();
            
        async function initApp() {
            try {
                // Wait for Firebase to be fully initialized
                await Promise.race([
                    new Promise(resolve => setTimeout(resolve, 2000)), // Max 2 seconds wait
                    new Promise(resolve => {
                        const checkAuth = () => {
                            if (auth && db) resolve();
                            else setTimeout(checkAuth, 100);
                        };
                        checkAuth();
                    })
                ]);

                // Use onAuthStateChanged to properly handle auth state changes
                return new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            console.log('Auth state: User is signed in:', user.email);
                            // Update UI to show user is signed in
                            const userAvatar = document.querySelector('.user-avatar img');
                            if (userAvatar) {
                                userAvatar.src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}`;
                            }
                            
                            // Initialize the test creator only after confirming user is authenticated
                            initTestCreator();
                            resolve(true);
                        } else {
                            console.log('No user signed in, redirecting to login...');
                            // Redirect to login page if not authenticated
                            window.location.href = 'auth/login-fixed.html?redirect=' + encodeURIComponent(window.location.pathname);
                            resolve(false);
                        }
                    });
                    
                    // Set a timeout to ensure we don't wait forever
                    setTimeout(() => {
                        unsubscribe(); // Clean up the listener
                        if (!auth.currentUser) {
                            console.log('Auth check timed out, redirecting to login...');
                            window.location.href = 'auth/login-fixed.html?redirect=' + encodeURIComponent(window.location.pathname);
                            resolve(false);
                        }
                    }, 3000);
                });
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showNotification('Error initializing application. Please refresh the page.', 'error');
                return false;
            }
        }
        
        function initTestCreator() {
            console.log('Initializing test creator...');
            
            // Initialize the test creator components
            if (!init()) {
                console.error('Failed to initialize test creator components');
                return;
            }
            
            // Add event listeners
            const addSectionBtn = document.getElementById('add-section-btn');
            if (addSectionBtn) {
                console.log('Found add section button, adding click handler');
                // Remove any existing event listeners to prevent duplicates
                const newAddSectionBtn = addSectionBtn.cloneNode(true);
                addSectionBtn.parentNode.replaceChild(newAddSectionBtn, addSectionBtn);
                newAddSectionBtn.addEventListener('click', addNewSection);
            } else {
                console.error('Could not find add section button');
            }
            
            const previewBtn = document.getElementById('preview-test-btn');
            if (previewBtn) {
                previewBtn.addEventListener('click', previewTest);
            }
            
            const publishBtn = document.getElementById('publish-test-btn');
            if (publishBtn) {
                publishBtn.addEventListener('click', publishTest);
            }
            
            // Clear existing sections
            if (sectionsContainer) {
                sectionsContainer.innerHTML = '';
            }
            
            // Reset section count
            sectionCount = 0;
            
            // Add the first section by default
            console.log('Adding first section...');
            addNewSection();
            console.log('Test creator initialization complete');
        }
        
        // Function to log auth state
        function logAuthState(user) {
            console.log('Auth State Changed:', user ? 'User is signed in' : 'No user signed in');
            if (user) {
                console.log('User UID:', user.uid);
                console.log('Email:', user.email);
                console.log('Email Verified:', user.emailVerified);
                console.log('Auth Persistence:', auth.currentUser ? 'User exists in auth' : 'No user in auth');
            }
        }

        // State
        let sectionCount = 0;
        let itemCount = 0;
        
        // DOM Elements
        let sectionsContainer;
        let addSectionBtn;
        let saveDraftBtn;
        let previewTestBtn;
        let publishTestBtn;
        let sectionTemplate;
        let wordItemTemplate;
        let passageItemTemplate;
        
        // Initialize the test creator
        function init() {
            console.log('Initializing test creator components...');
            
            // Initialize DOM elements
            sectionsContainer = document.getElementById('sections-container');
            
            // Get templates
            sectionTemplate = document.getElementById('section-template');
            wordItemTemplate = document.getElementById('word-item-template');
            passageItemTemplate = document.getElementById('passage-item-template');
            
            // Initialize sections container if it exists
            if (!sectionsContainer) {
                console.error('Sections container not found');
                return false;
            }
            
            // Make sure templates exist
            if (!sectionTemplate || !wordItemTemplate || !passageItemTemplate) {
                console.error('One or more templates not found');
                return false;
            }
            
            console.log('Test creator components initialized');
            return true;
        }
        
        // Add a new section to the test
            function addNewSection() {
                console.log('Adding new section...');
                sectionCount++;
                const sectionId = `section-${sectionCount}`;
                
                // Get the sections container
                const sectionsContainer = document.getElementById('sections-container');
                if (!sectionsContainer) {
                    console.error('Sections container not found');
                    return;
                }
                
                // Get the template
                const template = document.getElementById('section-template');
                if (!template) {
                    console.error('Section template not found');
                    return;
                }
                
                // Clone the template content
                const sectionDiv = document.importNode(template.content, true).firstElementChild;
                sectionDiv.dataset.sectionId = sectionId;
                
                // Set up the section title input and other event listeners
                const titleInput = sectionDiv.querySelector('.section-title-input');
                const sectionTitle = sectionDiv.querySelector('.section-title');
                const deleteBtn = sectionDiv.querySelector('.delete-section');
                const addItemBtn = sectionDiv.querySelector('.add-item-btn');
                
                // Set up title input
                if (titleInput && sectionTitle) {
                    titleInput.addEventListener('input', (e) => {
                        const title = e.target.value.trim();
                        sectionTitle.textContent = title || 'New Section';
                    });
                    
                    // Focus the title input
                    setTimeout(() => {
                        titleInput.focus();
                    }, 0);
                }
                
                // Set up delete button
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (confirm('Are you sure you want to delete this section?')) {
                            sectionDiv.remove();
                        }
                    });
                }
                
                // Add item button setup is now handled in initSectionFunctionality
                
                // Add the section to the container
                sectionsContainer.appendChild(sectionDiv);
                console.log('Section added to container');
                
                // Initialize section functionality
                initSectionFunctionality(sectionDiv);
                console.log('Section functionality initialized');
            }
            
            // Initialize functionality for a section
            function initSectionFunctionality(section) {
                if (!section) {
                    console.error('No section provided');
                    return;
                }
                
                // Add item button
                const addItemBtn = section.querySelector('.add-item-btn');
                if (addItemBtn) {
                    addItemBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        addNewItem(section);
                    });
                }
                
                // Section type change handler
                const sectionType = section.querySelector('.section-type');
                if (sectionType) {
                    sectionType.addEventListener('change', (e) => {
                        const itemsContainer = section.querySelector('.items-container');
                        if (itemsContainer) {
                            // Clear existing items when section type changes
                            itemsContainer.innerHTML = '';
                            // Add a new item of the selected type
                            addNewItem(section);
                        }
                    });
                }
                
                // Move up/down buttons
                const moveUpBtn = section.querySelector('.move-section-up');
                const moveDownBtn = section.querySelector('.move-section-down');
                
                if (moveUpBtn) {
                    moveUpBtn.addEventListener('click', () => {
                        const prev = section.previousElementSibling;
                        if (prev && prev !== sectionsContainer.firstElementChild) {
                            sectionsContainer.insertBefore(section, prev);
                        }
                    });
                }
                
                if (moveDownBtn) {
                    moveDownBtn.addEventListener('click', () => {
                        const next = section.nextElementSibling;
                        if (next) {
                            sectionsContainer.insertBefore(next, section);
                        }
                    });
                }
            }
            
            // Add a new item to a section
            function addNewItem(section) {
                console.log('Adding new item to section');
                const itemsContainer = section.querySelector('.items-container');
                const sectionType = section.querySelector('.section-type').value;
                
                if (!itemsContainer) {
                    console.error('Items container not found in section');
                    return;
                }
                
                let itemTemplateId = 'word-item-template';
                
                // Choose template based on section type
                switch(sectionType) {
                    case 'passage':
                        itemTemplateId = 'passage-item-template';
                        break;
                    case 'sentences':
                        itemTemplateId = 'sentence-item-template';
                        break;
                    case 'letters':
                        itemTemplateId = 'letter-item-template';
                        break;
                    default: // words
                        itemTemplateId = 'word-item-template';
                }
                
                const itemTemplate = document.getElementById(itemTemplateId);
                if (!itemTemplate) {
                    console.error('Item template not found:', itemTemplateId);
                    return;
                }
                
                const itemElement = document.importNode(itemTemplate.content, true);
                const itemCard = itemElement.querySelector('.item-card');
                
                if (itemCard) {
                    itemCard.dataset.itemId = `item-${Date.now()}`;
                    
                    // Add delete functionality
                    const deleteBtn = itemCard.querySelector('.delete-item');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', () => {
                            itemCard.remove();
                        });
                    }
                    
                    // Add move up/down functionality
                    const moveUpBtn = itemCard.querySelector('.move-item-up');
                    const moveDownBtn = itemCard.querySelector('.move-item-down');
                    
                    if (moveUpBtn) {
                        moveUpBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const prev = itemCard.previousElementSibling;
                            if (prev) {
                                itemsContainer.insertBefore(itemCard, prev);
                            }
                        });
                    }
                    
                    if (moveDownBtn) {
                        moveDownBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const next = itemCard.nextElementSibling;
                            if (next) {
                                itemsContainer.insertBefore(next, itemCard);
                            }
                        });
                    }
                    
                    itemsContainer.appendChild(itemElement);
                    
                    // Focus the first input in the new item
                    const firstInput = itemCard.querySelector('input, textarea');
                    if (firstInput) {
                        setTimeout(() => firstInput.focus(), 0);
                    }
                }
            }
            
            // Save the test as a draft
            async function saveAsDraft() {
                try {
                    const testData = getTestData();
                    testData.status = 'draft';
                    testData.createdAt = serverTimestamp();
                    testData.updatedAt = serverTimestamp();
                    
                    const user = auth.currentUser;
                    
                    if (!user) {
                        throw new Error('User not authenticated');
                    }
                    
                    // Add the user ID to the test data
                    testData.teacherId = user.uid;
                    
                    // Save to Firestore
                    const docRef = await addDoc(collection(db, 'tests'), testData);
                    showNotification('Draft saved successfully!', 'success');
                    return docRef.id;
                } catch (error) {
                    console.error('Error saving draft:', error);
                    showNotification('Failed to save draft: ' + error.message, 'error');
                    throw error;
                }
            }
            
            // Preview the test
            function previewTest() {
                // Implementation for previewing the test
                showNotification('Preview functionality coming soon!', 'info');
            }
            
            // Show a loading state on the publish button
            function setPublishButtonLoading(isLoading) {
                const publishBtn = document.querySelector('.publish-btn');
                if (publishBtn) {
                    if (isLoading) {
                        publishBtn.disabled = true;
                        publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
                    } else {
                        publishBtn.disabled = false;
                        publishBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Publish Test';
                    }
                }
            }

            // Publish the test
            // Function to ensure user is authenticated
            async function ensureAuthenticated() {
                const auth = getAuth();
                
                // First check if we have a current user
                if (auth.currentUser) {
                    console.log('User already authenticated:', auth.currentUser.email);
                    return auth.currentUser;
                }
                
                console.log('No current user, waiting for auth state...');
                
                // If no current user, wait for auth state to be ready
                return new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        unsubscribe(); // Remove the listener
                        if (user) {
                            console.log('Auth state resolved with user:', user.email);
                            resolve(user);
                        } else {
                            console.log('Auth state resolved with no user');
                            reject(new Error('You must be logged in to publish a test. Please sign in and try again.'));
                        }
                    }, (error) => {
                        unsubscribe();
                        console.error('Auth state error:', error);
                        reject(new Error('Authentication error. Please refresh the page and try again.'));
                    });
                });
            }
            
            // Function to update the publish modal
            function updatePublishModal({ title, status, progress, details, isSuccess, isError, showClose }) {
                const modal = document.getElementById('publishModal');
                const titleEl = document.getElementById('publishTitle');
                const statusEl = document.getElementById('publishStatus');
                const progressEl = document.getElementById('publishProgress');
                const detailsEl = document.getElementById('publishDetails');
                const iconEl = modal.querySelector('.publish-icon i');
                const closeBtn = document.getElementById('publishCloseBtn');
                
                // Update elements if provided
                if (title) titleEl.textContent = title;
                if (status) statusEl.textContent = status;
                if (details) detailsEl.textContent = details;
                if (progress !== undefined) progressEl.style.width = `${progress}%`;
                
                // Update icon based on state
                if (isSuccess) {
                    modal.classList.add('publish-success');
                    modal.classList.remove('publish-error');
                    iconEl.className = 'fas fa-check-circle';
                } else if (isError) {
                    modal.classList.add('publish-error');
                    modal.classList.remove('publish-success');
                    iconEl.className = 'fas fa-exclamation-circle';
                } else {
                    modal.classList.remove('publish-success', 'publish-error');
                    iconEl.className = 'fas fa-spinner fa-spin';
                }
                
                // Show/hide close button
                closeBtn.style.display = showClose ? 'inline-block' : 'none';
                
                // Show modal if not already shown
                if (!modal.classList.contains('show')) {
                    modal.classList.add('show');
                }
            }
            
            // Function to simulate progress (for demo purposes)
            async function simulateProgress(callback) {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) {
                        clearInterval(interval);
                        callback();
                        return;
                    }
                    updatePublishModal({
                        progress: progress,
                        status: `Publishing... (${Math.round(progress)}%)`,
                        details: 'Saving your test to the server'
                    });
                }, 300);
            }
            
            async function publishTest() {
                const publishBtn = document.querySelector('.publish-btn');
                const modal = document.getElementById('publishModal');
                
                try {
                    console.log('Starting test publication...');
                    setPublishButtonLoading(true);
                    
                    // Show the publish modal
                    updatePublishModal({
                        title: 'Publishing Test',
                        status: 'Preparing your test...',
                        progress: 0,
                        details: 'This may take a few moments'
                    });
                    
                    // Ensure user is authenticated
                    updatePublishModal({
                        status: 'Verifying your account...'
                    });
                    
                    const user = await ensureAuthenticated();
                    console.log('User authenticated for publishing:', user.email);
                    
                    // Start progress simulation
                    await new Promise((resolve) => {
                        simulateProgress(resolve);
                    });
                    
                    updatePublishModal({
                        status: 'Validating test data...',
                        progress: 95
                    });
                    
                    // Get the test data
                    updatePublishModal({
                        status: 'Preparing test data...'
                    });
                    
                    const testData = getTestData();
                    console.log('Test data prepared:', JSON.stringify(testData, null, 2));
                    
                    // Basic validation
                    updatePublishModal({
                        status: 'Validating test content...'
                    });
                    
                    if (!testData.title || testData.title.trim() === '') {
                        throw new Error('Please enter a test title');
                    }
                    
                    if (!testData.sections || testData.sections.length === 0) {
                        throw new Error('Please add at least one section to the test');
                    }
                    
                    // Get user data
                    const userEmail = user.email || 'unknown@example.com';
                    const userName = user.displayName || 'Teacher';
                    const userType = localStorage.getItem('userType') || 'teacher';
                    
                    console.log('Publishing test as:', {
                        email: userEmail,
                        name: userName,
                        type: userType,
                        uid: user.uid
                    });
                    
                    // Ensure we have a valid user type
                    if (userType !== 'teacher') {
                        throw new Error('Only teachers can publish tests.');
                    }
                    
                    // Prepare test data for Firestore with proper structure
                    const testToSave = {
                        // Test metadata
                        title: testData.title.trim(),
                        description: (testData.description || '').trim(),
                        grade: testData.grade || '',
                        subject: testData.subject || 'Reading',
                        status: 'published',
                        isActive: true,
                        version: '1.0.0',
                        
                        // User information
                        createdBy: user.uid,
                        createdByEmail: userEmail,
                        createdByName: userName,
                        userType: userType,
                        
                        // Test content
                        sections: (testData.sections || []).map(section => ({
                            id: section.id || `section-${Date.now()}`,
                            title: section.title || 'Untitled Section',
                            type: section.type || 'letters',
                            instructions: section.instructions || '',
                            items: (section.items || []).map(item => ({
                                id: item.id || `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                                type: item.type || 'letter',
                                content: item.content || '',
                                points: parseInt(item.points) || 1,
                                example: item.example || '',
                                answer: item.answer || '',
                                focusWord: item.focusWord || '',
                                question: item.question || ''
                            })).filter(item => {
                                // Filter out empty items based on type
                                if (item.type === 'letter') return item.content.trim() !== '';
                                if (item.type === 'word') return item.content.trim() !== '' && item.answer.trim() !== '';
                                return true;
                            })
                        })).filter(section => section.items.length > 0), // Remove empty sections
                        
                        // Timestamps
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        publishedAt: serverTimestamp()
                    };
                    
                    console.log('Saving test to Firestore...', testToSave);
                    
                    try {
                        // Save to Firestore
                        updatePublishModal({
                            status: 'Saving to database...',
                            progress: 98
                        });
                        
                        const testsCollection = collection(db, 'tests');
                        const docRef = await addDoc(testsCollection, testToSave);
                        
                        console.log('Test saved with ID:', docRef.id);
                        
                        // Show success state
                        updatePublishModal({
                            title: 'Success!',
                            status: 'Test published successfully!',
                            progress: 100,
                            isSuccess: true,
                            details: 'Your test is now available for students.',
                            showClose: true
                        });
                        
                        // Add event listener to close button
                        document.getElementById('publishCloseBtn').onclick = () => {
                            window.location.href = 'teacher-dashboard.html';
                        };
                        
                        // Auto-redirect after delay
                        setTimeout(() => {
                            if (document.getElementById('publishModal').classList.contains('show')) {
                                window.location.href = 'teacher-dashboard.html';
                            }
                        }, 3000);
                        
                        return docRef.id;
                    } catch (firestoreError) {
                        console.error('Firestore error:', firestoreError);
                        
                        let errorMessage = 'Failed to save test. Please try again.';
                        
                        if (firestoreError.code === 'permission-denied') {
                            errorMessage = 'Permission denied. Please make sure you have the necessary permissions to publish tests.';
                        } else if (firestoreError.code === 'unavailable') {
                            errorMessage = 'Unable to connect to the server. Please check your internet connection.';
                        } else if (firestoreError.code === 'unauthenticated') {
                            errorMessage = 'Your session has expired. Please sign in and try again.';
                        } else if (firestoreError.message) {
                            errorMessage = firestoreError.message;
                        }
                        
                        throw new Error(errorMessage);
                    }
                } catch (error) {
                    console.error('Error publishing test:', error);
                    
                    // Update modal to show error
                    updatePublishModal({
                        title: 'Publishing Failed',
                        status: 'An error occurred',
                        details: error.message || 'Please try again later.',
                        isError: true,
                        showClose: true
                    });
                    
                    // Add event listener to close button
                    document.getElementById('publishCloseBtn').onclick = () => {
                        document.getElementById('publishModal').classList.remove('show');
                    };
                    
                    // Re-enable the publish button
                    setPublishButtonLoading(false);
                    
                    // Show error notification
                    showNotification('Error: ' + error.message, 'error');
                    
                    // Re-throw the error for any error handling up the chain
                    throw error;
                }
            }
            
            // Get all test data as an object
            function getTestData() {
                // Only include primitive types and arrays/objects of primitive types
                // Firestore doesn't support custom class instances or undefined values
                const testData = {
                    title: document.getElementById('test-title')?.value || 'Untitled Test',
                    description: document.getElementById('test-description')?.value || '',
                    grade: document.getElementById('test-grade')?.value || '',
                    subject: document.getElementById('test-subject')?.value || 'Reading',
                    sections: [],
                    createdBy: localStorage.getItem('userType') || 'teacher',
                    // Note: We'll let Firestore handle the timestamps when saving
                };
                
                // Add sections data
                const sections = document.querySelectorAll('.section-card');
                sections.forEach((section, index) => {
                    const sectionType = section.querySelector('.section-type')?.value || 'words';
                    const sectionData = {
                        id: section.dataset.sectionId || `section-${Date.now()}-${index}`,
                        title: section.querySelector('.section-title-input')?.value || `Section ${index + 1}`,
                        type: sectionType,
                        instructions: section.querySelector('.section-instructions')?.value || '',
                        items: []
                    };
                    
                    // Add items data
                    const items = section.querySelectorAll('.item-card');
                    items.forEach(item => {
                        const itemType = item.dataset.itemType || sectionType;
                        const itemContent = item.querySelector('.item-text')?.value || 
                                         item.querySelector('.item-content')?.value || '';
                        
                        // Skip empty items
                        if (itemType === 'letter' && itemContent.trim() === '') {
                            return; // Skip this item
                        }
                        
                        const itemData = {
                            id: item.dataset.itemId || `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            type: itemType,
                            content: itemContent,
                            points: parseInt(item.querySelector('.item-points')?.value) || 1,
                            // Common fields for all item types
                            ...(itemType === 'letter' && {
                                example: item.querySelector('.item-example')?.value || ''
                            }),
                            ...(itemType === 'sentence' && {
                                focusWord: item.querySelector('.item-focus')?.value || ''
                            }),
                            ...(itemType === 'passage' && {
                                title: item.querySelector('.item-title')?.value || '',
                                question: item.querySelector('.item-question')?.value || ''
                            })
                        };
                        
                        // For word items, use the content as the answer if no specific answer field
                        if (itemType === 'word' && !itemData.answer) {
                            itemData.answer = itemContent;
                        }
                        
                        sectionData.items.push(itemData);
                    });
                    
                    testData.sections.push(sectionData);
                });
                
                return testData;
            }
            
            // Start the application
            initApp().catch(error => {
                console.error('Failed to initialize application:', error);
                showNotification('Failed to initialize application. Please refresh the page.', 'error');
            });
            
            // Show notification to the user
            function showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                // Add to the page
                document.body.appendChild(notification);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
    </script>
</body>
</html>
