<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Reading Test - Alpharia</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/teacher-dashboard.css">
    <link rel="stylesheet" href="css/test-creator.css">
</head>
<body class="teacher-dashboard">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h2>Alpharia</h2>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="teacher-dashboard.html" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link active">
                            <i class="fas fa-plus-circle"></i>
                            <span>Create Test</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="fas fa-file-alt"></i>
                            <span>My Tests</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span>Students</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <button id="logout-btn" class="btn btn-logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <h1>Create New Reading Test</h1>
                <div class="user-menu">
                    <div class="user-avatar">
                        <img src="https://ui-avatars.com/api/?name=Teacher+Name" alt="User" class="rounded-circle">
                    </div>
                </div>
            </header>

            <div class="test-creator-container">
                <!-- Test Info Section -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-info-circle"></i> Test Information</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="test-title">Test Title</label>
                            <input type="text" id="test-title" class="form-control" placeholder="Enter test title" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="test-grade">Grade Level</label>
                                <select id="test-grade" class="form-control" required>
                                    <option value="">Select grade</option>
                                    <option value="1">Grade 1</option>
                                    <option value="2">Grade 2</option>
                                    <option value="3">Grade 3</option>
                                    <option value="4">Grade 4</option>
                                    <option value="5">Grade 5</option>
                                    <option value="6">Grade 6</option>
                                    <option value="7">Grade 7</option>
                                    <option value="8">Grade 8</option>
                                    <option value="9">Grade 9</option>
                                    <option value="10">Grade 10</option>
                                    <option value="11">Grade 11</option>
                                    <option value="12">Grade 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="test-time-limit">Time Limit (minutes)</label>
                                <input type="number" id="test-time-limit" class="form-control" min="1" value="30">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="test-instructions">Instructions (Optional)</label>
                            <textarea id="test-instructions" class="form-control" rows="3" placeholder="Enter test instructions"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Sections Container -->
                <div id="sections-container" class="sections-container">
                    <!-- Sections will be added here dynamically -->
                </div>

                <!-- Add Section Button -->
                <div class="text-center">
                    <button type="button" class="btn btn-primary" id="add-section-btn">
                        <i class="fas fa-plus-circle"></i> Add Section
                    </button>
                </div>

                <!-- Save & Preview Buttons -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="save-draft-btn">
                        <i class="fas fa-save"></i> Save as Draft
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="preview-test-btn">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                    <button type="button" class="btn btn-success" id="publish-test-btn">
                        <i class="fas fa-paper-plane"></i> Publish Test
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Section Template (Hidden) -->
    <template id="section-template">
        <div class="card section-card" data-section-id="">
            <div class="card-header">
                <div class="section-header">
                    <h3 class="section-title">New Section</h3>
                    <div class="section-actions">
                        <button class="btn btn-sm btn-icon move-section-up" title="Move Up">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="btn btn-sm btn-icon move-section-down" title="Move Down">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="btn btn-sm btn-icon delete-section" title="Delete Section">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>Section Title</label>
                    <input type="text" class="form-control section-title-input" placeholder="Enter section title" required>
                </div>
                <div class="form-group">
                    <label>Instructions (Optional)</label>
                    <textarea class="form-control section-instructions" rows="2" placeholder="Enter section instructions"></textarea>
                </div>
                <div class="form-group">
                    <label>Section Type</label>
                    <select class="form-control section-type" required>
                        <option value="letters">Letters</option>
                        <option value="words">Words</option>
                        <option value="sentences">Sentences</option>
                        <option value="passage">Reading Passage</option>
                    </select>
                </div>
                
                <!-- Items Container -->
                <div class="items-container">
                    <!-- Items will be added here dynamically -->
                </div>
                
                <!-- Add your custom styles here -->
                <style>
                    /* Success Modal Styles */
                    .success-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: rgba(0, 0, 0, 0.7);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                        opacity: 0;
                        visibility: hidden;
                        transition: all 0.3s ease;
                    }
                    
                    .success-modal.active {
                        opacity: 1;
                        visibility: visible;
                    }
                    
                    .success-content {
                        background: white;
                        padding: 2rem;
                        border-radius: 8px;
                        text-align: center;
                        max-width: 400px;
                        width: 90%;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                        transform: translateY(20px);
                        transition: transform 0.3s ease;
                    }
                    
                    .success-modal.active .success-content {
                        transform: translateY(0);
                    }
                    
                    .success-icon {
                        font-size: 4rem;
                        color: #28a745;
                        margin-bottom: 1rem;
                    }
                    
                    .success-content h3 {
                        margin: 0 0 1rem 0;
                        color: #2c3e50;
                    }
                    
                    .success-content p {
                        margin-bottom: 1.5rem;
                        color: #555;
                    }
                    
                    .success-content .btn {
                        min-width: 150px;
                    }
                    
                    /* Loading state for publish button */
                    .publish-btn .fa-spinner {
                        margin-right: 8px;
                    }
                </style>
                
                <!-- Add Item Button -->
                <button class="btn btn-outline btn-sm add-item-btn">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
        </div>
    </template>

    <!-- Word Item Template -->
    <template id="word-item-template">
        <div class="item-card" data-item-type="word" data-item-id="">
            <div class="item-content">
                <div class="form-group">
                    <label>Word</label>
                    <input type="text" class="form-control item-text" placeholder="Enter word" required>
                </div>
                <div class="form-group">
                    <label>Points</label>
                    <input type="number" class="form-control item-points" min="1" value="1" required>
                </div>
            </div>
            <div class="item-actions">
                <button type="button" class="btn btn-sm btn-icon move-item-up" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon move-item-down" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon delete-item" title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </template>

    <!-- Letter Item Template -->
    <template id="letter-item-template">
        <div class="item-card" data-item-type="letter" data-item-id="">
            <div class="item-content">
                <div class="form-group">
                    <label>Letter</label>
                    <input type="text" class="form-control item-text" placeholder="Enter letter" maxlength="1" required>
                </div>
                <div class="form-group">
                    <label>Example Word</label>
                    <input type="text" class="form-control item-example" placeholder="Example word with this letter">
                </div>
                <div class="form-group">
                    <label>Points</label>
                    <input type="number" class="form-control item-points" min="1" value="1" required>
                </div>
            </div>
            <div class="item-actions">
                <button type="button" class="btn btn-sm btn-icon move-item-up" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon move-item-down" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon delete-item" title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </template>

    <!-- Sentence Item Template -->
    <template id="sentence-item-template">
        <div class="item-card" data-item-type="sentence" data-item-id="">
            <div class="item-content">
                <div class="form-group">
                    <label>Sentence</label>
                    <textarea class="form-control item-text" rows="2" placeholder="Enter sentence" required></textarea>
                </div>
                <div class="form-group">
                    <label>Focus Word</label>
                    <input type="text" class="form-control item-focus" placeholder="Word to focus on (optional)">
                </div>
                <div class="form-group">
                    <label>Points</label>
                    <input type="number" class="form-control item-points" min="1" value="2" required>
                </div>
            </div>
            <div class="item-actions">
                <button type="button" class="btn btn-sm btn-icon move-item-up" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon move-item-down" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon delete-item" title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </template>

    <!-- Passage Item Template -->
    <template id="passage-item-template">
        <div class="item-card" data-item-type="passage" data-item-id="">
            <div class="item-content">
                <div class="form-group">
                    <label>Passage Title</label>
                    <input type="text" class="form-control item-title" placeholder="Enter passage title" required>
                </div>
                <div class="form-group">
                    <label>Passage Content</label>
                    <textarea class="form-control item-text" rows="4" placeholder="Enter passage content" required></textarea>
                </div>
                <div class="form-group">
                    <label>Comprehension Question (Optional)</label>
                    <input type="text" class="form-control item-question" placeholder="Add a question about this passage">
                </div>
                <div class="form-group">
                    <label>Points</label>
                    <input type="number" class="form-control item-points" min="1" value="5" required>
                </div>
            </div>
            <div class="item-actions">
                <button type="button" class="btn btn-sm btn-icon move-item-up" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon move-item-down" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-sm btn-icon delete-item" title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </template>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { 
            initializeApp 
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        
        import { 
            getAuth, 
            onAuthStateChanged,
            setPersistence,
            browserSessionPersistence,
            browserLocalPersistence
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            doc,
            serverTimestamp,
            enableIndexedDbPersistence
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        
        import { getApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD8wzA2bX2jzvJ1wR4X5XwQdQk8cZ6X9Y0",
            authDomain: "alpharia-12345.firebaseapp.com",
            projectId: "alpharia-12345",
            storageBucket: "alpharia-12345.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abc123def456"
        };
        
        // Initialize Firebase
        let app;
        let auth;
        let db;
        
        try {
            // Check if Firebase is already initialized
            app = initializeApp(firebaseConfig, 'test-creator');
            auth = getAuth(app);
            db = getFirestore(app);
            
            // Enable offline persistence
            enableIndexedDbPersistence(db).catch((err) => {
                if (err.code === 'failed-precondition') {
                    console.warn('Offline persistence can only be enabled in one tab at a time.');
                } else if (err.code === 'unimplemented') {
                    console.warn('The current browser does not support offline persistence.');
                }
            });
            
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            // If already initialized, get the existing instance
            if (error.code === 'app/duplicate-app') {
                app = getApp('test-creator');
                auth = getAuth(app);
                db = getFirestore(app);
                console.log('Using existing Firebase app instance');
            } else {
                throw error;
            }
        }
        
        // Set persistence to LOCAL to keep user logged in
        setPersistence(auth, browserLocalPersistence)
            .then(() => {
                console.log('Auth persistence set to LOCAL');
                // Only initialize the app after persistence is set
                initApp();
            })
            .catch((error) => {
                console.error('Error setting auth persistence:', error);
                // Still try to initialize the app even if persistence fails
                initApp();
            });
            
        function initApp() {
            // Initialize the test creator when the page loads
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOM Content Loaded');
                
                // Initialize the test creator
                console.log('Initializing test creator...');
                init();
                
                // Log auth state but don't redirect
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log('User is signed in:', user.email);
                    } else {
                        console.log('No user is signed in - but not redirecting');
                    }
                });
            });
        }
        
        // Function to log auth state
        function logAuthState(user) {
            console.log('Auth State Changed:', user ? 'User is signed in' : 'No user signed in');
            if (user) {
                console.log('User UID:', user.uid);
                console.log('Email:', user.email);
                console.log('Email Verified:', user.emailVerified);
                console.log('Auth Persistence:', auth.currentUser ? 'User exists in auth' : 'No user in auth');
            }
        }

        // State
        let sectionCount = 0;
        let itemCount = 0;
        
        // DOM Elements
        let sectionsContainer;
        let addSectionBtn;
        let saveDraftBtn;
        let previewTestBtn;
        let publishTestBtn;
        let sectionTemplate;
        
        // Initialize the test creator when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            
            // Initialize the test creator
            console.log('Initializing test creator...');
            init();
            
            // Optional: Still log auth state but don't redirect
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log('User is signed in:', user.email);
                } else {
                    console.log('No user is signed in');
                }
            });
        });
        
        // Initialize the test creator
        function init() {
                console.log('Initializing test creator...');
                
                // Initialize DOM elements
                sectionsContainer = document.getElementById('sections-container');
                addSectionBtn = document.getElementById('add-section-btn');
                saveDraftBtn = document.getElementById('save-draft-btn');
                previewTestBtn = document.getElementById('preview-test-btn');
                publishTestBtn = document.getElementById('publish-test-btn');
                sectionTemplate = document.getElementById('section-template');
                
                console.log('DOM Elements:', { 
                    sectionsContainer: !!sectionsContainer,
                    addSectionBtn: !!addSectionBtn,
                    saveDraftBtn: !!saveDraftBtn,
                    previewTestBtn: !!previewTestBtn,
                    publishTestBtn: !!publishTestBtn,
                    sectionTemplate: !!sectionTemplate
                });
                
                // Add event listeners
                if (addSectionBtn) {
                    console.log('Adding click event to Add Section button');
                    addSectionBtn.addEventListener('click', addNewSection);
                } else {
                    console.error('Add Section button not found!');
                }
                
                if (saveDraftBtn) saveDraftBtn.addEventListener('click', saveAsDraft);
                if (previewTestBtn) previewTestBtn.addEventListener('click', previewTest);
                if (publishTestBtn) publishTestBtn.addEventListener('click', publishTest);
                
                // Add the first section by default
                addNewSection();
            }
            
            // Add a new section to the test
            function addNewSection() {
                console.log('Adding new section...');
                sectionCount++;
                const sectionId = `section-${sectionCount}`;
                
                // Check if template exists
                if (!sectionTemplate) {
                    console.error('Section template not found!');
                    return;
                }
                
                // Clone the section template
                const sectionElement = document.importNode(sectionTemplate.content, true);
                const sectionCard = sectionElement.querySelector('.section-card');
                
                if (!sectionCard) {
                    console.error('Could not find section card in template');
                    return;
                }
                
                sectionCard.dataset.sectionId = sectionId;
                
                // Create section title element if it doesn't exist
                let sectionTitle = sectionCard.querySelector('.section-title');
                if (!sectionTitle) {
                    sectionTitle = document.createElement('h3');
                    sectionTitle.className = 'section-title';
                    sectionTitle.textContent = ''; // Start with empty title
                    
                    // Insert the title before the section actions
                    const sectionHeader = sectionCard.querySelector('.section-header');
                    if (sectionHeader) {
                        sectionHeader.insertBefore(sectionTitle, sectionHeader.firstChild);
                    }
                }
                
                // Update section title input
                const titleInput = sectionCard.querySelector('.section-title-input');
                if (titleInput) {
                    titleInput.placeholder = 'Enter section title';
                    titleInput.value = ''; // Clear any default value
                    
                    titleInput.addEventListener('input', (e) => {
                        const title = e.target.value.trim();
                        if (sectionTitle) {
                            sectionTitle.textContent = title;
                        }
                    });
                    
                    // Focus the title input when section is created
                    setTimeout(() => {
                        titleInput.focus();
                    }, 0);
                }
                
                // Add event listeners for section actions
                const deleteBtn = sectionCard.querySelector('.delete-section');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        sectionCard.remove();
                    });
                }
                
                // Add the section to the container
                if (sectionsContainer) {
                    sectionsContainer.appendChild(sectionElement);
                    console.log('Section added to container');
                } else {
                    console.error('Sections container not found');
                }
                
                // Initialize any additional section functionality
                initSectionFunctionality(sectionCard);
            }
            
            // Initialize functionality for a section
            function initSectionFunctionality(section) {
                if (!sectionsContainer) {
                    console.error('Sections container not initialized');
                    return;
                }
                
                // Add item button
                const addItemBtn = section.querySelector('.add-item-btn');
                if (addItemBtn) {
                    addItemBtn.addEventListener('click', () => {
                        addNewItem(section);
                    });
                }
                
                // Move up/down buttons
                const moveUpBtn = section.querySelector('.move-section-up');
                const moveDownBtn = section.querySelector('.move-section-down');
                
                if (moveUpBtn) {
                    moveUpBtn.addEventListener('click', () => {
                        const prev = section.previousElementSibling;
                        if (prev && prev !== sectionsContainer.firstElementChild) {
                            sectionsContainer.insertBefore(section, prev);
                        }
                    });
                }
                
                if (moveDownBtn) {
                    moveDownBtn.addEventListener('click', () => {
                        const next = section.nextElementSibling;
                        if (next) {
                            sectionsContainer.insertBefore(next, section);
                        }
                    });
                }
            }
            
            // Add a new item to a section
            function addNewItem(section) {
                console.log('Adding new item to section');
                const itemsContainer = section.querySelector('.items-container');
                const sectionType = section.querySelector('.section-type').value;
                
                if (!itemsContainer) {
                    console.error('Items container not found in section');
                    return;
                }
                
                let itemTemplateId = 'word-item-template';
                
                // Choose template based on section type
                switch(sectionType) {
                    case 'passage':
                        itemTemplateId = 'passage-item-template';
                        break;
                    case 'sentences':
                        itemTemplateId = 'sentence-item-template';
                        break;
                    case 'letters':
                        itemTemplateId = 'letter-item-template';
                        break;
                    default: // words
                        itemTemplateId = 'word-item-template';
                }
                
                const itemTemplate = document.getElementById(itemTemplateId);
                if (!itemTemplate) {
                    console.error('Item template not found:', itemTemplateId);
                    return;
                }
                
                const itemElement = document.importNode(itemTemplate.content, true);
                const itemCard = itemElement.querySelector('.item-card');
                
                if (itemCard) {
                    itemCard.dataset.itemId = `item-${Date.now()}`;
                    
                    // Add delete functionality
                    const deleteBtn = itemCard.querySelector('.delete-item');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', () => {
                            itemCard.remove();
                        });
                    }
                    
                    // Add move up/down functionality
                    const moveUpBtn = itemCard.querySelector('.move-item-up');
                    const moveDownBtn = itemCard.querySelector('.move-item-down');
                    
                    if (moveUpBtn) {
                        moveUpBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const prev = itemCard.previousElementSibling;
                            if (prev) {
                                itemsContainer.insertBefore(itemCard, prev);
                            }
                        });
                    }
                    
                    if (moveDownBtn) {
                        moveDownBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const next = itemCard.nextElementSibling;
                            if (next) {
                                itemsContainer.insertBefore(next, itemCard);
                            }
                        });
                    }
                    
                    itemsContainer.appendChild(itemElement);
                    
                    // Focus the first input in the new item
                    const firstInput = itemCard.querySelector('input, textarea');
                    if (firstInput) {
                        setTimeout(() => firstInput.focus(), 0);
                    }
                }
            }
            
            // Save the test as a draft
            async function saveAsDraft() {
                try {
                    const testData = getTestData();
                    testData.status = 'draft';
                    testData.createdAt = serverTimestamp();
                    testData.updatedAt = serverTimestamp();
                    
                    const user = auth.currentUser;
                    
                    if (!user) {
                        throw new Error('User not authenticated');
                    }
                    
                    // Add the user ID to the test data
                    testData.teacherId = user.uid;
                    
                    // Save to Firestore
                    const docRef = await addDoc(collection(db, 'tests'), testData);
                    showNotification('Draft saved successfully!', 'success');
                    return docRef.id;
                } catch (error) {
                    console.error('Error saving draft:', error);
                    showNotification('Failed to save draft: ' + error.message, 'error');
                    throw error;
                }
            }
            
            // Preview the test
            function previewTest() {
                // Implementation for previewing the test
                showNotification('Preview functionality coming soon!', 'info');
            }
            
            // Show a loading state on the publish button
            function setPublishButtonLoading(isLoading) {
                const publishBtn = document.querySelector('.publish-btn');
                if (publishBtn) {
                    if (isLoading) {
                        publishBtn.disabled = true;
                        publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
                    } else {
                        publishBtn.disabled = false;
                        publishBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Publish Test';
                    }
                }
            }

            // Publish the test
            async function publishTest() {
                const publishBtn = document.querySelector('.publish-btn');
                try {
                    console.log('Starting test publication...');
                    setPublishButtonLoading(true);
                    showNotification('Publishing test...', 'info');
                    
                    // Get the test data
                    const testData = getTestData();
                    console.log('Test data prepared:', JSON.stringify(testData, null, 2));
                    
                    // Validate test data
                    if (!testData.title || testData.title.trim() === '') {
                        throw new Error('Please enter a test title');
                    }
                    
                    if (testData.sections.length === 0) {
                        throw new Error('Please add at least one section to the test');
                    }
                    
                    // Validate sections and items
                    for (const section of testData.sections) {
                        if (!section.items || section.items.length === 0) {
                            throw new Error(`Section "${section.title || 'Untitled Section'}" has no items`);
                        }
                        
                        // Validate items based on type
                        for (const item of section.items) {
                            if (item.type === 'letter' && !item.content) {
                                throw new Error('Letter items must have content');
                            }
                            if (item.type === 'word' && (!item.content || !item.answer)) {
                                throw new Error('Word items must have both content and answer');
                            }
                        }
                    }
                    
                    // Prepare test data for Firestore
                    const testToSave = {
                        title: testData.title.trim(),
                        description: (testData.description || '').trim(),
                        grade: testData.grade || '',
                        subject: testData.subject || 'Reading',
                        status: 'published',
                        createdBy: localStorage.getItem('userType') || 'teacher',
                        createdByEmail: localStorage.getItem('userEmail') || 'teacher@example.com',
                        isActive: true,
                        version: '1.0.0',
                        sections: testData.sections || [],
                        // Use Firestore server-side timestamps
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        publishedAt: serverTimestamp()
                    };
                    
                    console.log('Saving test to Firestore...', testToSave);
                    
                    try {
                        // Save to Firestore with error handling
                        const testsCollection = collection(db, 'tests');
                        console.log('Collection reference created');
                        
                        const docRef = await addDoc(testsCollection, testToSave);
                        console.log('Test saved with ID:', docRef.id);
                        
                        // Show success message
                        showNotification('Test published successfully!', 'success');
                        
                        // Show a more prominent success message
                        const successModal = document.createElement('div');
                        successModal.className = 'success-modal';
                        successModal.innerHTML = `
                            <div class="success-content">
                                <div class="success-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h3>Test Published Successfully!</h3>
                                <p>Your test has been published and is now available for students.</p>
                                <button id="continue-btn" class="btn btn-primary">Continue to Dashboard</button>
                            </div>
                        `;
                        document.body.appendChild(successModal);
                        
                        // Add click handler for the continue button
                        document.getElementById('continue-btn').addEventListener('click', () => {
                            window.location.href = 'teacher-dashboard.html';
                        });
                        
                        return docRef.id;
                    } catch (firestoreError) {
                        console.error('Firestore error:', firestoreError);
                        
                        // Check for common Firestore errors
                        if (firestoreError.code === 'permission-denied') {
                            throw new Error('Permission denied. Please check your Firestore security rules.');
                        } else if (firestoreError.code === 'unavailable') {
                            throw new Error('Unable to connect to the server. Please check your internet connection.');
                        } else {
                            throw new Error(`Failed to save test: ${firestoreError.message}`);
                        }
                    }
                } catch (error) {
                    console.error('Error publishing test:', error);
                    showNotification('Error: ' + error.message, 'error');
                    setPublishButtonLoading(false);
                    throw error;
                }
            }
            
            // Get all test data as an object
            function getTestData() {
                // Only include primitive types and arrays/objects of primitive types
                // Firestore doesn't support custom class instances or undefined values
                const testData = {
                    title: document.getElementById('test-title')?.value || 'Untitled Test',
                    description: document.getElementById('test-description')?.value || '',
                    grade: document.getElementById('test-grade')?.value || '',
                    subject: document.getElementById('test-subject')?.value || 'Reading',
                    sections: [],
                    createdBy: localStorage.getItem('userType') || 'teacher',
                    // Note: We'll let Firestore handle the timestamps when saving
                };
                
                // Add sections data
                const sections = document.querySelectorAll('.section-card');
                sections.forEach((section, index) => {
                    const sectionType = section.querySelector('.section-type')?.value || 'words';
                    const sectionData = {
                        id: section.dataset.sectionId || `section-${Date.now()}-${index}`,
                        title: section.querySelector('.section-title-input')?.value || `Section ${index + 1}`,
                        type: sectionType,
                        instructions: section.querySelector('.section-instructions')?.value || '',
                        items: []
                    };
                    
                    // Add items data
                    const items = section.querySelectorAll('.item-card');
                    items.forEach(item => {
                        const itemType = item.dataset.itemType || sectionType;
                        const itemContent = item.querySelector('.item-text')?.value || 
                                         item.querySelector('.item-content')?.value || '';
                        
                        // Skip empty items
                        if (itemType === 'letter' && itemContent.trim() === '') {
                            return; // Skip this item
                        }
                        
                        const itemData = {
                            id: item.dataset.itemId || `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            type: itemType,
                            content: itemContent,
                            points: parseInt(item.querySelector('.item-points')?.value) || 1,
                            // Common fields for all item types
                            ...(itemType === 'letter' && {
                                example: item.querySelector('.item-example')?.value || ''
                            }),
                            ...(itemType === 'sentence' && {
                                focusWord: item.querySelector('.item-focus')?.value || ''
                            }),
                            ...(itemType === 'passage' && {
                                title: item.querySelector('.item-title')?.value || '',
                                question: item.querySelector('.item-question')?.value || ''
                            })
                        };
                        
                        // For word items, use the content as the answer if no specific answer field
                        if (itemType === 'word' && !itemData.answer) {
                            itemData.answer = itemContent;
                        }
                        
                        sectionData.items.push(itemData);
                    });
                    
                    testData.sections.push(sectionData);
                });
                
                return testData;
            }
            
            // Show notification to the user
            function showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                // Add to the page
                document.body.appendChild(notification);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
    </script>
</body>
</html>
