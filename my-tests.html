<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tests - Alpharia</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/student-dashboard-clean.css">
    <style>
        .test-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid #4e73df;
        }
        
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .test-card h3 {
            color: #2d3748;
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .test-meta {
            display: flex;
            gap: 15px;
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .test-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .test-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        .btn-start {
            background-color: #4e73df;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .btn-start:hover {
            background-color: #2e59d9;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 1.8rem;
            color: #2d3748;
            margin: 0;
        }
        
        .test-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-available {
            background-color: #c6f6d5;
            color: #22543d;
        }
        
        .status-completed {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        
        .status-in-progress {
            background-color: #feebc8;
            color: #9c4221;
        }
    </style>
</head>
<body class="student-dashboard">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h2>Alpharia</h2>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="student-dashboard-clean.html" class="nav-link">
                            <i class="fas fa-home"></i>
                            <span>Overview</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="my-tests.html" class="nav-link active">
                            <i class="fas fa-tasks"></i>
                            <span>My Tests</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="student-progress.html" class="nav-link">
                            <i class="fas fa-chart-line"></i>
                            <span>Progress</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="fas fa-book"></i>
                            <span>Resources</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="student-settings.html" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-tests" placeholder="Search tests...">
                </div>
                
                <div class="user-menu">
                    <a href="#notifications" class="notification-icon">
                        <i class="fas fa-bell"></i>
                        <span class="badge">0</span>
                    </a>
                    
                    <div class="user-avatar">
                        <img src="https://ui-avatars.com/api/?name=Student+Name&background=4361ee&color=fff" 
                             alt="User" 
                             class="rounded-circle"
                             width="40"
                             height="40">
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="dashboard-content">
                <div class="page-header">
                    <h1 class="page-title">My Tests</h1>
                </div>
                
                <!-- Test Filters -->
                <div class="test-filters">
                    <button class="filter-btn active" data-filter="all">All Tests</button>
                    <button class="filter-btn" data-filter="available">Available</button>
                    <button class="filter-btn" data-filter="in-progress">In Progress</button>
                    <button class="filter-btn" data-filter="completed">Completed</button>
                </div>
                
                <!-- Tests Grid -->
                <div id="tests-container" class="test-grid">
                    <!-- Tests will be loaded here dynamically -->
                    <div class="loading-message">
                        <p>Loading tests...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            // Your Firebase config here (same as in other files)
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // DOM Elements
        const testsContainer = document.getElementById('tests-container');
        const searchInput = document.getElementById('search-tests');
        const filterButtons = document.querySelectorAll('.filter-btn');
        
        // Current filter
        let currentFilter = 'all';
        
        // Fetch tests from Firestore
        async function fetchTests() {
            try {
                testsContainer.innerHTML = '<div class="loading-message"><p>Loading tests...</p></div>';
                
                // Get current user
                const user = firebase.auth().currentUser;
                if (!user) {
                    window.location.href = '/auth/login-fixed.html';
                    return;
                }
                
                // Get student's grade/level (you'll need to store this in the user's document)
                const studentDoc = await db.collection('students').doc(user.uid).get();
                const studentData = studentDoc.data();
                const studentGrade = studentData?.grade || 1; // Default to grade 1 if not set
                
                // Get tests that match the student's grade or are for all grades
                const testsSnapshot = await db.collection('tests')
                    .where('isPublished', '==', true)
                    .where('grade', 'in', [studentGrade, 'all'])
                    .orderBy('createdAt', 'desc')
                    .get();
                
                // Get the student's test attempts
                const attemptsSnapshot = await db.collection('testAttempts')
                    .where('studentId', '==', user.uid)
                    .get();
                
                // Process test attempts to get completion status
                const attempts = {};
                attemptsSnapshot.forEach(doc => {
                    const attempt = doc.data();
                    attempts[attempt.testId] = {
                        status: attempt.completed ? 'completed' : 'in-progress',
                        score: attempt.score,
                        maxScore: attempt.maxScore
                    };
                });
                
                // Display tests
                if (testsSnapshot.empty) {
                    testsContainer.innerHTML = `
                        <div class="no-tests">
                            <i class="fas fa-clipboard-list" style="font-size: 48px; color: #cbd5e0; margin-bottom: 15px;"></i>
                            <h3>No Tests Available</h3>
                            <p>There are no tests available for your grade level at the moment.</p>
                        </div>
                    `;
                    return;
                }
                
                let testsHTML = '';
                testsSnapshot.forEach(doc => {
                    const test = doc.data();
                    const testId = doc.id;
                    const attempt = attempts[testId];
                    const status = attempt?.status || 'available';
                    
                    // Skip tests that don't match the current filter
                    if (currentFilter !== 'all' && status !== currentFilter) {
                        return;
                    }
                    
                    testsHTML += `
                        <div class="test-card" data-status="${status}">
                            <div class="test-header">
                                <h3>${test.title || 'Untitled Test'}</h3>
                                <span class="test-status status-${status}">
                                    ${status === 'completed' ? 'Completed' : 
                                      status === 'in-progress' ? 'In Progress' : 'Available'}
                                </span>
                            </div>
                            
                            <div class="test-meta">
                                <span><i class="fas fa-book-open"></i> ${test.sections?.length || 0} Sections</span>
                                <span><i class="fas fa-question-circle"></i> ${test.totalQuestions || 0} Questions</span>
                                <span><i class="fas fa-clock"></i> ${test.timeLimit || 'No'} time limit</span>
                            </div>
                            
                            <p class="test-description">
                                ${test.description || 'No description available.'}
                            </p>
                            
                            <div class="test-actions">
                                <div class="test-grade">
                                    ${status === 'completed' ? 
                                        `<span class="text-success">
                                            <i class="fas fa-check-circle"></i> 
                                            Score: ${attempt.score}/${attempt.maxScore}
                                        </span>` : 
                                        status === 'in-progress' ?
                                        `<span class="text-warning">
                                            <i class="fas fa-spinner"></i> In Progress
                                        </span>` :
                                        `<span class="text-primary">
                                            <i class="fas fa-play-circle"></i> Available
                                        </span>`
                                    }
                                </div>
                                <button class="btn-start" 
                                        data-test-id="${testId}" 
                                        data-test-title="${test.title || 'Test'}">
                                    ${status === 'completed' ? 'View Results' : 
                                      status === 'in-progress' ? 'Continue' : 'Start Test'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                testsContainer.innerHTML = testsHTML || `
                    <div class="no-tests">
                        <i class="fas fa-filter" style="font-size: 48px; color: #cbd5e0; margin-bottom: 15px;"></i>
                        <h3>No Tests Match Your Filter</h3>
                        <p>Try changing your filter or check back later for new tests.</p>
                    </div>
                `;
                
                // Add event listeners to test buttons
                document.querySelectorAll('.btn-start').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const testId = e.target.getAttribute('data-test-id');
                        const testTitle = e.target.getAttribute('data-test-title');
                        startTest(testId, testTitle);
                    });
                });
                
            } catch (error) {
                console.error('Error fetching tests:', error);
                testsContainer.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle" style="color: #e53e3e; font-size: 24px; margin-bottom: 10px;"></i>
                        <h3>Error Loading Tests</h3>
                        <p>There was a problem loading your tests. Please try again later.</p>
                        <button class="btn-start" onclick="window.location.reload()">
                            <i class="fas fa-sync-alt"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }
        
        // Start a test
        function startTest(testId, testTitle) {
            // Store test info in session storage
            sessionStorage.setItem('currentTestId', testId);
            sessionStorage.setItem('currentTestTitle', testTitle);
            
            // Redirect to the test page
            window.location.href = 'take-test.html';
        }
        
        // Filter tests
        function filterTests(filter) {
            currentFilter = filter;
            
            // Update active filter button
            filterButtons.forEach(btn => {
                if (btn.getAttribute('data-filter') === filter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Re-fetch and filter tests
            fetchTests();
        }
        
        // Search tests
        function searchTests(query) {
            const testCards = document.querySelectorAll('.test-card');
            const searchTerm = query.toLowerCase().trim();
            
            testCards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                const description = card.querySelector('.test-description').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || description.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Check auth status
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in, fetch tests
                    fetchTests();
                } else {
                    // No user is signed in, redirect to login
                    window.location.href = '/auth/login-fixed.html';
                }
            });
            
            // Filter buttons
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const filter = btn.getAttribute('data-filter');
                    filterTests(filter);
                });
            });
            
            // Search input
            searchInput.addEventListener('input', (e) => {
                searchTests(e.target.value);
            });
        });
    </script>
</body>
</html>
