<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Details - Alpharia</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/teacher-dashboard.css">
    <style>
        .test-header {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .question-card {
            border-left: 4px solid #4e73df;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .question-card .card-body {
            padding: 1rem;
        }
        .question-card .question-text {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .question-card .question-answer {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .creator-info {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .creator-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #4e73df;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        .test-meta {
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="teacher-dashboard">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h2>Alpharia <span class="admin-badge">Admin</span></h2>
            </div>
            
            <nav class="nav-menu">
                <div class="menu-title">Main Menu</div>
                
                <div class="nav-item">
                    <a href="admin-dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="admin-management.html" class="nav-link">
                        <i class="fas fa-users-cog"></i>
                        <span>Management</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="admin-tests.html" class="nav-link">
                        <i class="fas fa-clipboard-list"></i>
                        <span>All Tests</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="admin-create-test.html" class="nav-link">
                        <i class="fas fa-plus-circle"></i>
                        <span>Create Test</span>
                    </a>
                </div>
                
                <div class="menu-title mt-4">Analytics</div>
                
                <div class="nav-item">
                    <a href="admin-reports.html" class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                    </a>
                </div>
                
                <div class="menu-title mt-4">Account</div>
                
                <div class="nav-item">
                    <a href="admin-settings.html" class="nav-link">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="help.html" class="nav-link">
                        <i class="fas fa-question-circle"></i>
                        <span>Help & Support</span>
                    </a>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-profile">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=4a6cf7&color=fff" alt="User" class="user-avatar" id="user-avatar-sidebar">
                    <div class="user-info">
                        <h4 class="user-name" id="sidebar-admin-name">Loading...</h4>
                        <span class="user-role">Administrator</span>
                    </div>
                    <button class="sign-out" id="logout-btn" title="Sign Out">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2>Test Details</h2>
                </div>
                
                <div class="top-bar-right">
                    <div class="user-menu" id="user-menu">
                        <button class="user-menu-button" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                            <div class="user-avatar">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <div class="user-info">
                                <span class="user-name" id="user-name">Admin</span>
                                <span class="user-role">Administrator</span>
                            </div>
                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                        </button>
                        
                        <div class="dropdown-menu" id="user-dropdown" aria-labelledby="user-menu-button" style="min-width: 180px; padding: 4px 0; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border: 1px solid rgba(0, 0, 0, 0.05);">
                            <a href="admin-settings.html" class="dropdown-item" style="padding: 8px 16px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-user-cog" style="width: 20px; text-align: center;"></i>
                                <span>Settings</span>
                            </a>
                            <div class="dropdown-divider" style="margin: 4px 0; height: 1px; background-color: #f0f0f0;"></div>
                            <a href="#" class="dropdown-item text-danger" id="logout-button" style="padding: 8px 16px; font-size: 14px; display: flex; align-items: center; gap: 8px; color: #dc3545;">
                                <i class="fas fa-sign-out-alt" style="width: 20px; text-align: center;"></i>
                                <span>Logout</span>
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item" id="admin-logout-btn">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="dashboard-content">
                <div class="test-header">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2 id="test-title">Loading test...</h2>
                        <div class="test-meta" id="test-meta"></div>
                    </div>
                    <div class="creator-info">
                        <div class="creator-avatar" id="creator-avatar">T</div>
                        <div>
                            <div id="creator-name">Teacher</div>
                            <div class="test-meta" id="test-date"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Test Questions</h5>
                    </div>
                    <div class="card-body">
                        <div id="questions-container">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        console.log('Script loading...');
        
        // Log when imports start
        console.log('Starting imports...');
        
        // Import Firebase modules
        let firebaseApp, auth, db, firebaseFunctions = {};
        
        try {
            // Import Firebase App
            const firebaseAppModule = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js');
            firebaseFunctions.initializeApp = firebaseAppModule.initializeApp;
            console.log('Firebase App imported');
            
            // Import Auth
            const firebaseAuth = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js');
            firebaseFunctions.getAuth = firebaseAuth.getAuth;
            firebaseFunctions.signOut = firebaseAuth.signOut;
            firebaseFunctions.onAuthStateChanged = firebaseAuth.onAuthStateChanged;
            firebaseFunctions.setPersistence = firebaseAuth.setPersistence;
            firebaseFunctions.browserLocalPersistence = firebaseAuth.browserLocalPersistence;
            console.log('Firebase Auth imported');
            
            // Import Firestore
            const firestoreModule = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');
            firebaseFunctions.getFirestore = firestoreModule.getFirestore;
            firebaseFunctions.doc = firestoreModule.doc;
            firebaseFunctions.getDoc = firestoreModule.getDoc;
            console.log('Firebase Firestore imported');
            
            // Make functions globally available for now (temporary solution)
            window.firebaseFunctions = firebaseFunctions;

            // Firebase configuration - using the same as in firebase.js
            console.log('Initializing Firebase...');
            const firebaseConfig = {
            apiKey: "AIzaSyAtOedXLBC4eigzqmBpYFciN-W5Mi2Cpmc",
            authDomain: "alpharia-c6a39.firebaseapp.com",
            projectId: "alpharia-c6a39",
            storageBucket: "alpharia-c6a39.firebasestorage.app",
            messagingSenderId: "85322759772",
            appId: "1:85322759772:web:d5c7a528fd61c9d2373099",
            measurementId: "G-KEC7MGMVE8"
        };

            // Initialize Firebase with persistence
            firebaseApp = firebaseFunctions.initializeApp(firebaseConfig, 'test-details');
            auth = firebaseFunctions.getAuth(firebaseApp);
            db = firebaseFunctions.getFirestore(firebaseApp);
            
            console.log('Firebase initialized with config:', firebaseConfig);
            
            // Set persistence to local to maintain session
            try {
                await firebaseFunctions.setPersistence(auth, firebaseFunctions.browserLocalPersistence);
                console.log('Persistence set');
            } catch (error) {
                console.warn('Could not set persistence:', error);
            }
            
            // Start the app
            console.log('Starting application...');
            init();
            
        } catch (error) {
            console.error('Error during initialization:', error);
            document.body.innerHTML = `
                <div style="padding: 20px; color: red; font-family: Arial, sans-serif;">
                    <h2>Initialization Error</h2>
                    <p>${error.message}</p>
                    <p>Check the console for more details.</p>
                </div>`;
        }

        // DOM Elements
        const testTitle = document.getElementById('test-title');
        const testMeta = document.getElementById('test-meta');
        const creatorName = document.getElementById('creator-name');
        const creatorAvatar = document.getElementById('creator-avatar');
        const testDate = document.getElementById('test-date');
        const questionsContainer = document.getElementById('questions-container');
        const logoutBtn = document.getElementById('admin-logout-btn');

        // Get test ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const testId = urlParams.get('id');

        // Load test details
        async function loadTestDetails() {
            console.log('loadTestDetails called with testId:', testId);
            
            if (!testId) {
                const errorMsg = 'No test ID provided in URL';
                console.error(errorMsg);
                showError(errorMsg);
                return;
            }

            try {
                console.log('Fetching test document with ID:', testId);
                const testDoc = await getDoc(doc(db, 'tests', testId));
                
                if (!testDoc.exists()) {
                    const errorMsg = `Test with ID ${testId} not found`;
                    console.error(errorMsg);
                    showError(errorMsg);
                    return;
                }

                const testData = testDoc.data();
                console.log('Test data loaded:', testData);
                
                // Update UI with test details
                console.log('Updating UI with test title:', testData.title);
                testTitle.textContent = testData.title || 'Untitled Test';
                
                // Count total items across all sections
                let totalItems = 0;
                if (testData.sections && testData.sections.length > 0) {
                    totalItems = testData.sections.reduce((sum, section) => {
                        return sum + (section.items ? section.items.length : 0);
                    }, 0);
                }
                testMeta.textContent = `• ${testData.sections?.length || 0} sections • ${totalItems} items`;
                
                const createdDate = testData.createdAt ? testData.createdAt.toDate() : new Date();
                testDate.textContent = `Created on ${createdDate.toLocaleDateString()} by ${testData.createdByName || 'Unknown Teacher'}`;
                
                // Set creator info
                creatorName.textContent = testData.createdByName || 'Unknown Teacher';
                creatorAvatar.textContent = testData.createdByName ? testData.createdByName.charAt(0).toUpperCase() : 'T';
                
                // Display sections and items
                if (testData.sections && testData.sections.length > 0) {
                    console.log(`Found ${testData.sections.length} sections, displaying...`);
                    displaySections(testData.sections);
                } else {
                    console.warn('No sections found in test data');
                    questionsContainer.innerHTML = '<div class="alert alert-info">No sections found in this test.</div>';
                }
                
            } catch (error) {
                console.error('Error loading test details:', error);
                showError('Failed to load test details. Please try again.');
            }
        }

        // Display sections and items
        function displaySections(sections) {
            let html = '';
            
            sections.forEach((section, sectionIndex) => {
                html += `
                    <div class="card section-card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">${section.title || `Section ${sectionIndex + 1}`} <small class="text-muted">${section.type || ''}</small></h5>
                            ${section.instructions ? `<p class="mb-0 mt-1 small text-muted">${section.instructions}</p>` : ''}
                        </div>
                        <div class="card-body">
                            ${displaySectionItems(section.items || [])}
                        </div>
                    </div>`;
            });
            
            questionsContainer.innerHTML = html || '<div class="alert alert-info">No content found in this test.</div>';
        }
        
        // Display items within a section
        function displaySectionItems(items) {
            if (!items || items.length === 0) {
                return '<div class="alert alert-warning mb-0">No items in this section</div>';
            }
            
            return items.map((item, index) => {
                return `
                    <div class="item-card mb-3 p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>#${index + 1}</strong> 
                                <span class="ms-2">${item.type || 'item'}</span>
                                ${item.points ? `<span class="badge bg-primary ms-2">${item.points} pts</span>` : ''}
                            </div>
                        </div>
                        
                        <div class="mt-2">
                            ${item.content ? `<div class="mb-2"><strong>Content:</strong> ${item.content}</div>` : ''}
                            ${item.question ? `<div class="mb-2"><strong>Question:</strong> ${item.question}</div>` : ''}
                            ${item.answer ? `<div class="mb-2"><strong>Answer:</strong> ${item.answer}</div>` : ''}
                            ${item.example ? `<div class="mb-2"><strong>Example:</strong> ${item.example}</div>` : ''}
                            ${item.focusWord ? `<div class="mb-2"><strong>Focus Word:</strong> ${item.focusWord}</div>` : ''}
                        </div>
                    </div>`;
            }).join('');
        }

        // Show error message
        function showError(message) {
            questionsContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>`;
        }

        // Handle logout
        async function handleLogout() {
            try {
                await signOut(auth);
                window.location.href = 'admin-login.html';
            } catch (error) {
                console.error('Error signing out:', error);
                showError('Failed to sign out. Please try again.');
            }
        }

        // Initialize the page
        // Initialize the page
        async function initializePage() {
            console.log('Initializing test details page...');
            
            try {
                // Set up event listeners
                document.getElementById('sidebar-toggle')?.addEventListener('click', () => {
                    document.getElementById('sidebar')?.classList.toggle('collapsed');
                    document.body.classList.toggle('sidebar-collapsed');
                });
                
                // Check authentication state
                return new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        console.log('Auth state changed:', user ? 'User logged in' : 'No user');
                        
                        if (!user) {
                            console.log('No user found, redirecting to login...');
                            window.location.href = 'admin-login.html';
                            return;
                        }
                        
                        try {
                            // Update UI with user info
                            const userDoc = await getDoc(doc(db, 'admins', user.uid));
                            if (!userDoc.exists()) {
                                console.log('User is not an admin, redirecting...');
                                window.location.href = 'unauthorized.html';
                                return;
                            }
                            
                            const userData = userDoc.data();
                            document.getElementById('user-name').textContent = userData.displayName || 'Admin';
                            document.getElementById('user-avatar').textContent = userData.displayName ? 
                                userData.displayName.charAt(0).toUpperCase() : 'A';
                            
                            // Load test details
                            console.log('Loading test details...');
                            await loadTestDetails();
                            resolve();
                            
                        } catch (error) {
                            console.error('Error initializing page:', error);
                            showError('Failed to initialize page. Please try again.');
                            reject(error);
                        } finally {
                            unsubscribe(); // Clean up the auth state listener
                        }
                    }, (error) => {
                        console.error('Auth state error:', error);
                        showError('Authentication error. Please refresh the page.');
                        reject(error);
                    });
                });
            } catch (error) {
                console.error('Error in page initialization:', error);
                showError('Failed to initialize page. Please check console for details.');
            }
        }
        
        // Set up other event listeners
        function setupEventListeners() {
            document.getElementById('user-menu-button')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('dropdown-menu')?.classList.toggle('show');
            });
            
            document.getElementById('admin-logout-btn')?.addEventListener('click', handleLogout);
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('dropdown-menu');
                if (dropdown && !e.target.closest('#user-menu')) {
                    dropdown.classList.remove('show');
                }
            });
        }
        
        // Simple initialization
        async function init() {
            console.log('Initializing page...');
            
            try {
                // Get test ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const testId = urlParams.get('id');
                console.log('Test ID from URL:', testId);
                
                if (!testId) {
                    throw new Error('No test ID provided in URL');
                }
                
                // Load test data directly
                console.log('Loading test data...');
                const testDoc = await window.firebaseFunctions.getDoc(
                    window.firebaseFunctions.doc(db, 'tests', testId)
                );
                
                if (!testDoc.exists()) {
                    throw new Error('Test not found');
                }
                
                const testData = testDoc.data();
                console.log('Test data loaded:', testData);
                
                // Update UI
                document.getElementById('test-title').textContent = testData.title || 'Untitled Test';
                
                // Count total items
                let totalItems = 0;
                if (testData.sections && testData.sections.length > 0) {
                    totalItems = testData.sections.reduce((sum, section) => {
                        return sum + (section.items ? section.items.length : 0);
                    }, 0);
                    
                    // Display sections
                    displaySections(testData.sections);
                }
                
                document.getElementById('test-meta').textContent = 
                    `• ${testData.sections?.length || 0} sections • ${totalItems} items`;
                
                const createdDate = testData.createdAt ? testData.createdAt.toDate() : new Date();
                document.getElementById('test-date').textContent = 
                    `Created on ${createdDate.toLocaleDateString()} by ${testData.createdByName || 'Unknown Teacher'}`;
                
                // Set creator info
                document.getElementById('creator-name').textContent = testData.createdByName || 'Unknown Teacher';
                document.getElementById('creator-avatar').textContent = 
                    testData.createdByName ? testData.createdByName.charAt(0).toUpperCase() : 'T';
                
                console.log('Page initialized successfully');
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('questions-container').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading test: ${error.message}
                    </div>`;
            }
        }
        
        // Start initialization when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded');
            init();
        });
    </script>
</body>
</html>
